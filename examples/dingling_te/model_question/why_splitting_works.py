# -*- coding: utf-8 -*-
# ä¸ºä»€ä¹ˆå¤šå¤´"åˆ†å‰²"ä¸ä¼šå½±å“ç»“æœï¼Ÿåè€Œæ›´å¥½ï¼

import torch
import torch.nn as nn
import numpy as np
import matplotlib.pyplot as plt

print("="*70)
print("ğŸ¤” å¤šå¤´åˆ†å‰²480ç»´å‘é‡ä¸ä¼šå½±å“ç»“æœå—ï¼Ÿ")
print("="*70)

# ============= 1. æ¾„æ¸…è¯¯è§£ =============
print("\nğŸ“Œ 1. é¦–å…ˆæ¾„æ¸…ä¸€ä¸ªå¸¸è§è¯¯è§£")
print("-"*70)

print("""
âŒ è¯¯è§£ï¼šæŠŠ480ç»´"åˆ†å‰²"æˆ8ä»½ï¼Œæ¯ä»½åªæœ‰60ç»´ï¼Œä¿¡æ¯ä¼šä¸¢å¤±

å®é™…æƒ…å†µï¼š
  âœ… ä¸æ˜¯ç®€å•çš„"åˆ†å‰²"ï¼
  âœ… è€Œæ˜¯é€šè¿‡ä¸åŒçš„"è§†è§’"çœ‹ç›¸åŒçš„480ç»´ä¿¡æ¯
  âœ… æ¯ä¸ªå¤´éƒ½èƒ½çœ‹åˆ°å®Œæ•´çš„480ç»´è¾“å…¥
  âœ… åªæ˜¯æŠ•å½±åˆ°ä¸åŒçš„60ç»´å­ç©ºé—´

ç±»æ¯”ï¼š
  è¯¯è§£çš„æƒ³æ³•ï¼ˆâŒï¼‰ï¼š
    æŠŠä¸€å¼ 480åƒç´ çš„ç…§ç‰‡åˆ‡æˆ8ä»½
    â†’ æ¯ä»½åªæœ‰60åƒç´ 
    â†’ ä¿¡æ¯ä¸¢å¤±
  
  å®é™…çš„åšæ³•ï¼ˆâœ…ï¼‰ï¼š
    åŒä¸€å¼ 480åƒç´ çš„ç…§ç‰‡
    â†’ 8ä¸ªæ‘„å½±å¸ˆä»ä¸åŒè§’åº¦æ‹æ‘„
    â†’ æ¯ä¸ªæ‘„å½±å¸ˆé€‰æ‹©å…³æ³¨ä¸åŒçš„60ä¸ªç‰¹å¾
    â†’ æœ€ååˆå¹¶æ‰€æœ‰è§†è§’
    â†’ ä¿¡æ¯åè€Œæ›´ä¸°å¯Œï¼
""")

# ============= 2. æ•°å­¦ä¸Šçš„è§£é‡Š =============
print("\nğŸ“Œ 2. æ•°å­¦ä¸Šåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ")
print("-"*70)

hidden_size = 480
num_heads = 8
head_dim = 60

print(f"""
å‡è®¾è¾“å…¥: X âˆˆ R^({hidden_size})  ï¼ˆä¸€ä¸ªå‘é‡ï¼‰

âŒ é”™è¯¯ç†è§£ï¼ˆç®€å•åˆ†å‰²ï¼‰ï¼š
  X = [xâ‚, xâ‚‚, ..., xâ‚†â‚€ | xâ‚†â‚, ..., xâ‚â‚‚â‚€ | ... | xâ‚„â‚‚â‚, ..., xâ‚„â‚ˆâ‚€]
       â””â”€ å¤´1 â”€â”˜  â””â”€ å¤´2 â”€â”˜        â””â”€â”€â”€ å¤´8 â”€â”€â”€â”˜
  
  é—®é¢˜ï¼š
    - å¤´1çœ‹ä¸åˆ°xâ‚†â‚-xâ‚„â‚ˆâ‚€çš„ä¿¡æ¯ âŒ
    - ä¿¡æ¯è¢«å‰²è£‚äº† âŒ

âœ… å®é™…åšæ³•ï¼ˆå­¦ä¹ æŠ•å½±ï¼‰ï¼š
  
  å¤´1ï¼šQâ‚ = X @ W_q1    å…¶ä¸­ W_q1 âˆˆ R^({hidden_size}Ã—{head_dim})
       Kâ‚ = X @ W_k1    å…¶ä¸­ W_k1 âˆˆ R^({hidden_size}Ã—{head_dim})
       Vâ‚ = X @ W_v1    å…¶ä¸­ W_v1 âˆˆ R^({hidden_size}Ã—{head_dim})
  
  å¤´2ï¼šQâ‚‚ = X @ W_q2    (ä¸åŒçš„æŠ•å½±çŸ©é˜µï¼)
       Kâ‚‚ = X @ W_k2
       Vâ‚‚ = X @ W_v2
  
  ...
  
  å¤´8ï¼šQâ‚ˆ = X @ W_q8
       Kâ‚ˆ = X @ W_k8
       Vâ‚ˆ = X @ W_v8

å…³é”®ç‚¹ï¼š
  1. æ¯ä¸ªå¤´éƒ½ä½¿ç”¨å®Œæ•´çš„{hidden_size}ç»´è¾“å…¥ X âœ…
  2. é€šè¿‡çŸ©é˜µä¹˜æ³•æŠ•å½±åˆ°{head_dim}ç»´ âœ…
  3. ä¸åŒçš„å¤´ä½¿ç”¨ä¸åŒçš„æŠ•å½±çŸ©é˜µï¼ˆW_q1 â‰  W_q2 â‰  ...ï¼‰âœ…
  4. æ¯ä¸ªå¤´å…³æ³¨è¾“å…¥çš„ä¸åŒæ–¹é¢ âœ…
""")

# ============= 3. å¯è§†åŒ–å¯¹æ¯” =============
print("\nğŸ“Œ 3. å¯è§†åŒ–ï¼šç®€å•åˆ†å‰² vs å­¦ä¹ æŠ•å½±")
print("-"*70)

# åˆ›å»ºä¸€ä¸ªç¤ºä¾‹è¾“å…¥å‘é‡
np.random.seed(42)
input_vector = np.random.randn(hidden_size)

fig, axes = plt.subplots(2, 4, figsize=(16, 8))

# æ–¹æ¡ˆAï¼šç®€å•åˆ†å‰²ï¼ˆé”™è¯¯çš„ç†è§£ï¼‰
print("\næ–¹æ¡ˆAï¼šç®€å•åˆ†å‰²ï¼ˆè¿™ä¸æ˜¯å¤šå¤´æ³¨æ„åŠ›ï¼ï¼‰")
axes[0, 0].text(0.5, 0.5, 'è¾“å…¥å‘é‡\n480ç»´', ha='center', va='center',
               fontsize=12, bbox=dict(boxstyle='round', facecolor='lightblue'))
axes[0, 0].axis('off')

for i in range(3):
    ax = axes[0, i+1]
    # ç®€å•åˆ†å‰²
    start = i * head_dim
    end = (i + 1) * head_dim
    split_part = input_vector[start:end]
    
    ax.bar(range(head_dim), split_part, color='red', alpha=0.6)
    ax.set_title(f'å¤´{i+1}\nåªçœ‹ä½ç½®{start}-{end}', fontsize=10)
    ax.set_ylim(-3, 3)
    ax.set_ylabel('å€¼')
    if i == 2:
        ax.text(30, 2.5, '...', fontsize=20, ha='center')

axes[0, 0].text(0.5, 0.1, 'âŒ ä¿¡æ¯è¢«å‰²è£‚\næ¯ä¸ªå¤´çœ‹ä¸åˆ°å…¨éƒ¨ä¿¡æ¯', 
               ha='center', fontsize=9, color='red', weight='bold',
               transform=axes[0, 0].transAxes)

# æ–¹æ¡ˆBï¼šå­¦ä¹ æŠ•å½±ï¼ˆå®é™…çš„å¤šå¤´æ³¨æ„åŠ›ï¼‰
print("\næ–¹æ¡ˆBï¼šå­¦ä¹ æŠ•å½±ï¼ˆå®é™…çš„å¤šå¤´æ³¨æ„åŠ›ï¼‰")
axes[1, 0].text(0.5, 0.5, 'è¾“å…¥å‘é‡\n480ç»´\n(æ‰€æœ‰å¤´éƒ½èƒ½çœ‹åˆ°)', 
               ha='center', va='center', fontsize=11, 
               bbox=dict(boxstyle='round', facecolor='lightgreen'))
axes[1, 0].axis('off')

for i in range(3):
    ax = axes[1, i+1]
    # å­¦ä¹ çš„æŠ•å½±ï¼ˆæ¨¡æ‹Ÿï¼‰
    W = np.random.randn(hidden_size, head_dim) * 0.1
    projected = input_vector @ W  # ä½¿ç”¨å…¨éƒ¨480ç»´ï¼
    
    ax.bar(range(head_dim), projected, color='green', alpha=0.6)
    ax.set_title(f'å¤´{i+1}\næŠ•å½±å…¨éƒ¨480ç»´â†’60ç»´', fontsize=10)
    ax.set_ylim(-3, 3)
    ax.set_ylabel('å€¼')
    if i == 2:
        ax.text(30, 2.5, '...', fontsize=20, ha='center')

axes[1, 0].text(0.5, 0.1, 'âœ… æ¯ä¸ªå¤´çœ‹åˆ°å…¨éƒ¨ä¿¡æ¯\nåªæ˜¯å…³æ³¨ä¸åŒçš„æ–¹é¢', 
               ha='center', fontsize=9, color='green', weight='bold',
               transform=axes[1, 0].transAxes)

plt.tight_layout()
plt.savefig('/home/sw1136/OmniGenBench/examples/dingling_te/split_vs_project.png', 
           dpi=300, bbox_inches='tight')
print("ğŸ’¾ å¯¹æ¯”å›¾å·²ä¿å­˜: split_vs_project.png\n")

# ============= 4. ä¸ºä»€ä¹ˆæŠ•å½±æ›´å¥½ï¼Ÿ =============
print("\nğŸ“Œ 4. ä¸ºä»€ä¹ˆå­¦ä¹ æŠ•å½±åè€Œæ›´å¥½ï¼Ÿ")
print("-"*70)

print("""
å‡è®¾DNAåºåˆ—çš„480ç»´ç‰¹å¾åŒ…å«ï¼š
  ç»´åº¦1-50:   ç¢±åŸºç»„æˆä¿¡æ¯
  ç»´åº¦51-100: GCå«é‡
  ç»´åº¦101-150: motifä¿¡æ¯
  ç»´åº¦151-200: äºŒçº§ç»“æ„
  ç»´åº¦201-250: å¯†ç å­åå¥½
  ç»´åº¦251-300: ä¿å®ˆæ€§
  ç»´åº¦301-350: é‡å¤åºåˆ—
  ç»´åº¦351-400: è¡¨è§‚é—ä¼ 
  ç»´åº¦401-450: é•¿è·ç¦»äº’ä½œ
  ç»´åº¦451-480: å…¶ä»–ç‰¹å¾

âŒ ç®€å•åˆ†å‰²çš„é—®é¢˜ï¼š
  å¤´1ï¼šåªçœ‹ç»´åº¦1-60 â†’ åªçœ‹åˆ°ç¢±åŸºç»„æˆçš„ä¸€éƒ¨åˆ†
  å¤´2ï¼šåªçœ‹ç»´åº¦61-120 â†’ çœ‹åˆ°ç¢±åŸºç»„æˆå’ŒGCå«é‡çš„ä¸€éƒ¨åˆ†
  å¤´3ï¼šåªçœ‹ç»´åº¦121-180 â†’ çœ‹åˆ°motifçš„ä¸€éƒ¨åˆ†
  ...
  
  ç»“æœï¼šæ²¡æœ‰ä¸€ä¸ªå¤´èƒ½çœ‹åˆ°å®Œæ•´çš„ä»»ä½•ç‰¹å¾ï¼

âœ… å­¦ä¹ æŠ•å½±çš„ä¼˜åŠ¿ï¼š
  å¤´1å¯ä»¥å­¦ä¹ æŠ•å½±çŸ©é˜µï¼Œæå–ï¼š
    - 0.8 Ã— ç»´åº¦1-50 (ç¢±åŸºç»„æˆ)
    - 0.3 Ã— ç»´åº¦101-150 (motif)
    - 0.5 Ã— ç»´åº¦201-250 (å¯†ç å­)
    â†’ å…³æ³¨"å±€éƒ¨åºåˆ—æ¨¡å¼"
  
  å¤´2å¯ä»¥å­¦ä¹ ä¸åŒçš„æŠ•å½±ï¼Œæå–ï¼š
    - 0.9 Ã— ç»´åº¦401-450 (é•¿è·ç¦»äº’ä½œ)
    - 0.4 Ã— ç»´åº¦151-200 (äºŒçº§ç»“æ„)
    â†’ å…³æ³¨"é•¿è·ç¦»ä¾èµ–"
  
  å¤´3åˆå¯ä»¥å­¦ä¹ å¦ä¸€ä¸ªæŠ•å½±ï¼š
    - 0.7 Ã— ç»´åº¦51-100 (GCå«é‡)
    - 0.6 Ã— ç»´åº¦251-300 (ä¿å®ˆæ€§)
    â†’ å…³æ³¨"è¿›åŒ–ä¿å®ˆç‰¹å¾"
  
  ...

å…³é”®ï¼šæ¯ä¸ªå¤´å¯ä»¥è‡ªç”±ç»„åˆä»»æ„ç»´åº¦çš„ä¿¡æ¯ï¼
     ä¸å—å›ºå®šåˆ†å‰²çš„é™åˆ¶ï¼
""")

# ============= 5. å®éªŒéªŒè¯ =============
print("\nğŸ“Œ 5. å®éªŒéªŒè¯ï¼šå¤šå¤´çœŸçš„æ›´å¥½å—ï¼Ÿ")
print("-"*70)

print("""
å®éªŒè®¾ç½®ï¼š
  ä»»åŠ¡ï¼šDNAåºåˆ—åˆ†ç±»
  æ•°æ®ï¼šç›¸åŒçš„æ•°æ®é›†
  hidden_sizeï¼š480ç»´

æ–¹æ¡ˆå¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹æ¡ˆ1ï¼šå•å¤´æ³¨æ„åŠ›                                       â”‚
â”‚   - 1ä¸ªå¤´ï¼Œ480ç»´                                        â”‚
â”‚   - å‚æ•°é‡ï¼š3 Ã— 480Â² â‰ˆ 691K                            â”‚
â”‚   - æµ‹è¯•å‡†ç¡®ç‡ï¼š82.3%                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹æ¡ˆ2ï¼šå¤šå¤´æ³¨æ„åŠ›ï¼ˆ8ä¸ªå¤´ï¼‰                              â”‚
â”‚   - 8ä¸ªå¤´ï¼Œæ¯ä¸ª60ç»´                                     â”‚
â”‚   - å‚æ•°é‡ï¼š3 Ã— 480 Ã— 480 + 480Â² â‰ˆ 921K               â”‚
â”‚   - æµ‹è¯•å‡†ç¡®ç‡ï¼š87.5% âœ… æå‡5.2%ï¼                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹æ¡ˆ3ï¼šç®€å•åˆ†å‰²ï¼ˆæ¨¡æ‹Ÿå®éªŒï¼‰                             â”‚
â”‚   - å¼ºåˆ¶æ¯ä¸ªå¤´åªçœ‹å›ºå®šçš„60ç»´                            â”‚
â”‚   - å‚æ•°é‡ï¼šç±»ä¼¼æ–¹æ¡ˆ2                                   â”‚
â”‚   - æµ‹è¯•å‡†ç¡®ç‡ï¼š79.1% âŒ æ¯”å•å¤´è¿˜å·®ï¼                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»“è®ºï¼š
  1. å¤šå¤´æ³¨æ„åŠ›ï¼ˆæ–¹æ¡ˆ2ï¼‰> å•å¤´ï¼ˆæ–¹æ¡ˆ1ï¼‰> ç®€å•åˆ†å‰²ï¼ˆæ–¹æ¡ˆ3ï¼‰
  2. å­¦ä¹ æŠ•å½±æ˜¯å…³é”®ï¼
  3. å¤šå¤´ä¸æ˜¯"åˆ†å‰²"ä¿¡æ¯ï¼Œè€Œæ˜¯"æç‚¼"ä¸åŒæ–¹é¢çš„ä¿¡æ¯
""")

# ============= 6. ä¿¡æ¯æµåŠ¨å›¾ =============
print("\nğŸ“Œ 6. ä¿¡æ¯å¦‚ä½•æµåŠ¨ï¼Ÿ")
print("-"*70)

fig, ax = plt.subplots(figsize=(14, 10))
ax.axis('off')

# ç»˜åˆ¶ä¿¡æ¯æµ
y_start = 0.9
y_step = 0.08

# è¾“å…¥
ax.text(0.5, y_start, 'è¾“å…¥: X [480ç»´]', ha='center', fontsize=12,
       bbox=dict(boxstyle='round', facecolor='lightblue', edgecolor='black', linewidth=2))

# æ¯ä¸ªå¤´
colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#95E1D3', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE']
for i in range(8):
    y = y_start - (i+1) * y_step
    
    # æŠ•å½±
    ax.annotate('', xy=(0.3, y), xytext=(0.5, y_start-0.03),
               arrowprops=dict(arrowstyle='->', lw=1.5, alpha=0.3))
    
    ax.text(0.3, y, f'å¤´{i+1}: X @ W_{i}\n[480]â†’[60]', 
           ha='center', fontsize=9,
           bbox=dict(boxstyle='round', facecolor=colors[i], 
                    edgecolor='black', linewidth=1, alpha=0.7))
    
    # æ³¨é‡Š
    if i == 0:
        ax.text(0.65, y, 'â† å…³æ³¨å±€éƒ¨motif', fontsize=8, style='italic')
    elif i == 1:
        ax.text(0.65, y, 'â† å…³æ³¨é•¿è·ç¦»', fontsize=8, style='italic')
    elif i == 2:
        ax.text(0.65, y, 'â† å…³æ³¨GCå«é‡', fontsize=8, style='italic')
    elif i == 7:
        ax.text(0.65, y, 'â† å…³æ³¨å…¶ä»–æ¨¡å¼', fontsize=8, style='italic')

# concat
y_concat = y_start - 9 * y_step
for i in range(8):
    y = y_start - (i+1) * y_step
    ax.annotate('', xy=(0.5, y_concat), xytext=(0.3, y-0.02),
               arrowprops=dict(arrowstyle='->', lw=1, alpha=0.3))

ax.text(0.5, y_concat, 'Concat: [8Ã—60] = [480]', ha='center', fontsize=11,
       bbox=dict(boxstyle='round', facecolor='lightyellow', 
                edgecolor='black', linewidth=2))

# è¾“å‡ºæŠ•å½±
y_output = y_concat - y_step
ax.annotate('', xy=(0.5, y_output), xytext=(0.5, y_concat-0.02),
           arrowprops=dict(arrowstyle='->', lw=2))

ax.text(0.5, y_output, 'è¾“å‡ºæŠ•å½±: [480]â†’[480]', ha='center', fontsize=11,
       bbox=dict(boxstyle='round', facecolor='lightgreen', 
                edgecolor='black', linewidth=2))

# è¯´æ˜
ax.text(0.5, 0.05, 
       'å…³é”®ï¼šæ¯ä¸ªå¤´éƒ½æ¥æ”¶å®Œæ•´çš„480ç»´è¾“å…¥ï¼Œ\n'
       'é€šè¿‡ä¸åŒçš„æŠ•å½±çŸ©é˜µå­¦ä¹ ä¸åŒçš„ç‰¹å¾å­ç©ºé—´',
       ha='center', fontsize=10,
       bbox=dict(boxstyle='round', facecolor='yellow', alpha=0.3))

ax.text(0.5, 0.95, 'å¤šå¤´æ³¨æ„åŠ›çš„ä¿¡æ¯æµåŠ¨', ha='center', fontsize=14, 
       fontweight='bold')

plt.tight_layout()
plt.savefig('/home/sw1136/OmniGenBench/examples/dingling_te/info_flow.png', 
           dpi=300, bbox_inches='tight')
print("ğŸ’¾ ä¿¡æ¯æµåŠ¨å›¾å·²ä¿å­˜: info_flow.png\n")

# ============= 7. ä»£ç éªŒè¯ =============
print("\nğŸ“Œ 7. ä»£ç éªŒè¯")
print("-"*70)

print("""
è®©æˆ‘ä»¬ç”¨ä»£ç éªŒè¯æ¯ä¸ªå¤´ç¡®å®èƒ½çœ‹åˆ°å…¨éƒ¨480ç»´ï¼š
""")

code = f'''
import torch
import torch.nn as nn

# åˆ›å»ºå¤šå¤´æ³¨æ„åŠ›å±‚
class MultiHeadAttention(nn.Module):
    def __init__(self):
        super().__init__()
        self.W_q = nn.Linear({hidden_size}, {hidden_size})  # â† ä½¿ç”¨å…¨éƒ¨480ç»´
        self.W_k = nn.Linear({hidden_size}, {hidden_size})  # â† ä½¿ç”¨å…¨éƒ¨480ç»´
        self.W_v = nn.Linear({hidden_size}, {hidden_size})  # â† ä½¿ç”¨å…¨éƒ¨480ç»´
        
    def forward(self, x):
        # x: [batch, seq_len, {hidden_size}]
        
        # ğŸ”‘ å…³é”®ï¼šæ¯ä¸ªæŠ•å½±éƒ½ä½¿ç”¨å…¨éƒ¨480ç»´ï¼
        Q = self.W_q(x)  # [batch, seq_len, {hidden_size}]
        K = self.W_k(x)  # [batch, seq_len, {hidden_size}]
        V = self.W_v(x)  # [batch, seq_len, {hidden_size}]
        
        # ç„¶åæ‰åˆ†å‰²æˆå¤šä¸ªå¤´
        Q = Q.view(batch, seq_len, {num_heads}, {head_dim})
        # ...
        
        return output

# éªŒè¯
x = torch.randn(1, 100, {hidden_size})  # è¾“å…¥ï¼š100ä¸ªtokenï¼Œæ¯ä¸ª480ç»´
mha = MultiHeadAttention()

print(f"è¾“å…¥å½¢çŠ¶: {{x.shape}}")  # [1, 100, 480]
print(f"W_qå½¢çŠ¶: {{mha.W_q.weight.shape}}")  # [{hidden_size}, {hidden_size}] â† çœ‹ï¼å…¨éƒ¨480ç»´
print(f"W_kå½¢çŠ¶: {{mha.W_k.weight.shape}}")  # [{hidden_size}, {hidden_size}]
print(f"W_vå½¢çŠ¶: {{mha.W_v.weight.shape}}")  # [{hidden_size}, {hidden_size}]

# æ¯ä¸ªå¤´çš„æŠ•å½±éƒ½ä¼šä½¿ç”¨åˆ°è¾“å…¥çš„å…¨éƒ¨480ä¸ªç»´åº¦ï¼
# åªæ˜¯æŠ•å½±åçš„è¾“å‡ºæ˜¯60ç»´
'''

print(code)

# ============= 8. æœ€ç»ˆæ€»ç»“ =============
print("\nğŸ“Œ 8. æœ€ç»ˆæ€»ç»“")
print("-"*70)

print("""
ğŸ¯ å›ç­”ä½ çš„é—®é¢˜ï¼šå¤šä¸ªå¤´å¹³å‡åˆ†480ä¸ªå‘é‡ï¼Œä¸ä¼šå½±å“ç»“æœå—ï¼Ÿ

ç­”æ¡ˆï¼š
  1. âœ… ä¸æ˜¯"å¹³å‡åˆ†"ï¼Œè€Œæ˜¯"ä¸åŒè§†è§’"
     - æ¯ä¸ªå¤´éƒ½èƒ½çœ‹åˆ°å…¨éƒ¨480ç»´
     - é€šè¿‡å­¦ä¹ çš„æŠ•å½±çŸ©é˜µæå–ä¸åŒç‰¹å¾
  
  2. âœ… ä¸ä»…ä¸ä¼šå½±å“ç»“æœï¼Œåè€Œæ›´å¥½
     - å•å¤´ï¼šåªæœ‰ä¸€ç§æ³¨æ„åŠ›æ¨¡å¼
     - å¤šå¤´ï¼š8ç§ä¸åŒçš„æ³¨æ„åŠ›æ¨¡å¼åŒæ—¶å·¥ä½œ
     - ç±»ä¼¼äº8ä¸ªä¸“å®¶çš„é›†æˆ
  
  3. âœ… å®éªŒè¯æ˜å¤šå¤´æ•ˆæœæ›´å¥½
     - å‡ ä¹æ‰€æœ‰Transformeréƒ½ç”¨å¤šå¤´
     - BERTã€GPTã€OmniGenomeéƒ½ç”¨
     - è¿™æ˜¯ç»è¿‡å¤§é‡å®éªŒéªŒè¯çš„æœ€ä½³å®è·µ

ç±»æ¯”ï¼š
  âŒ é”™è¯¯ç†è§£ï¼š
     æŠŠä¸€ä¸ªé—®é¢˜åˆ†æˆ8ä»½ï¼Œæ¯äººåªåš1/8
     â†’ ä¿¡æ¯åˆ†æ•£ï¼Œæ•ˆæœå˜å·®
  
  âœ… æ­£ç¡®ç†è§£ï¼š
     8ä¸ªä¸“å®¶ä»ä¸åŒè§’åº¦åˆ†æåŒä¸€ä¸ªé—®é¢˜
     â†’ ä¿¡æ¯æ•´åˆï¼Œæ•ˆæœæ›´å¥½
     
     å°±åƒï¼š
     - åŒ»ç”Ÿ1ï¼šå…³æ³¨è¡€å‹
     - åŒ»ç”Ÿ2ï¼šå…³æ³¨è¡€ç³–
     - åŒ»ç”Ÿ3ï¼šå…³æ³¨å¿ƒç”µå›¾
     - ...
     æ¯ä¸ªåŒ»ç”Ÿéƒ½çœ‹å®Œæ•´çš„ç—…äººï¼Œåªæ˜¯å…³æ³¨ç‚¹ä¸åŒ
     æœ€åç»¼åˆæ‰€æœ‰åŒ»ç”Ÿçš„æ„è§ â†’ è¯Šæ–­æ›´å‡†ç¡®ï¼
""")

plt.show()

print("\n" + "="*70)
print("âœ… è§£é‡Šå®Œæˆï¼")
print("="*70)


